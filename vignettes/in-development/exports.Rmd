---
title: "Exports for various people"
output: html_notebook
---


```{r setup, include=FALSE}
library(tidyverse)
devtools::load_all("~/Git/uk-covid-datatools/")
ukcovidtools::reload()

devtools::load_all("~/Git/standard-print-output/")
ggplot2::theme_set(standardPrintOutput::defaultFigureLayout())
standardPrintOutput::setDefaults()
```

```{r}
#casesPerPillar = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = pillar)
casesPerSymptomatic = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = asymptomatic_indicator)
#casesPerEthnicity = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = ethnicity_final)
#casesPerIMD = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = imd_decile)

#breakdown111 = dpc$spim$getOneOneOneIncidence(dateFrom = as.Date("2020-07-01"))

#deathsPerResidence = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = residence_type)
#deathsPerEthicity = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = ethnicity_final)
deaths = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85))

others = dpc$spim$getSPIMextract()

icuAdmissions = others %>% filter(source == "chess_icu_admissions" & !is.na(ageCat) & codeType %in% c("CTRY","NHSER"))
admissions = others %>% filter(source %in% c("hospital_inc","hospital_inc_new") & !is.na(ageCat) & codeType %in% c("CTRY","NHSER"))
```

```{r}
## data for TJ
tmp1 = casesPerSymptomatic %>% filter(subgroup != "Y" & ageCat!="unknown")  %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()
tmp2 = admissions %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
tmp3 = icuAdmissions %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
tmp4 = deaths  %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
tmp5 = bind_rows(tmp1,tmp2,tmp3,tmp4) %>% tsp$logIncidenceStats() %>% filter(date > "2020-03-23")
tmp5 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forTJ-symptomaticCasesAdmissionsAndDeaths-AgeAndNHSER-GrowthRate-",Sys.Date(),".csv"))
```

```{r}
# This is the metawards data setup.
sds = dpc$spim$getSPIMextract()
inHospitalDeaths = sds %>% filter(statistic == "death" & source=="cpns_death_inc_line" & codeType=="NHS trust") %>% glimpse()
ggplot(inHospitalDeaths %>% filter(!is.na(ageCat)), aes(group=code,x=date, y=value)) + geom_line(alpha=0.1) + facet_wrap(vars(ageCat))
```


## data for Ellen

```{r}

tmp = casesPerSymptomatic %>% filter(codeType %in% c("CTRY","NHSER") & subgroup != "Y" & ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()
tmp2 = tmp %>% tsp$logIncidenceStats(growthRateWindow = 14) %>% tsp$estimateRt(window = 14)
tmp2 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forEllen-symptomaticCases-AgeAndRegionStratifiedRtAndGrowthRate-",Sys.Date(),".csv"))
```

Asymptomatic and Pillar 1 for type reproduction number.

```{r}
tmp = dpc$spim$getLineListIncidence(specimenOrReport = "specimen",subgroup = asymptomatic_indicator) %>%
      filter(codeType %in% c("CTRY","NHSER")) %>%
      tsp$aggregateAge() %>%
      tsp$aggregateGender() %>%
      dpc$demog$findDemographics()

tmp2 = tmp %>% tsp$estimateRtQuick(window = 14)

tmp3 = tmp %>% tsp$aggregateSubgroup() %>% tsp$estimateRtQuick(window = 14)
tmp4 = bind_rows(tmp2,tmp3)

tsp$plotRt(tmp4,colour = subgroup, dates = "2020-04-01", rtlim=c(0.5,2))+facet_wrap(vars(name))



tmp4 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forEllen-R_t-with-and-without-asymptomic-indicator-",Sys.Date(),".csv"))
```


## data for Leon - universities

Do you have an easy to digest incidence by ltla over time?
we're looking to do something quick with the university movement data....
Do you want smooth or raw incidence?
Raw (edited) 
we especially want students

```{r}

casesPerSymptomaticByAge = dpc$spim$getLineListIncidence(codeTypes = c("LAD","NHSER"), ageBreaks = c(6,10,18,23,35,45,55,65,75,85),filterExpr = asymptomatic_indicator!="Y")
tmp = casesPerSymptomaticByAge %>% filter(ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()
tmp %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forLeon-symptomaticCases-AgeAndLADStratified-raw-",Sys.Date(),".csv"))
describeDataframe(tmp) %>% yaml::write_yaml(paste0("~/Dropbox/covid19/exports/forLeon-symptomaticCases-AgeAndLADStratified-description-",Sys.Date(),".yaml"))
```
## Maps for TJ

```{r}
tmp = dpc$geog$getIntersection(inputMapId = "WD11", outputMapId = "LAD19")
tmp2 = tmp %>% as.data.frame() %>%mutate( areaFrac = intersectionArea/as.numeric(area.src)) %>% select(WD11_code = code.src,WD11_name = name.src, LAD19_code = code,LAD19_name=name,areaFrac)
tmp2 %>% write_csv("~/Dropbox/covid19/exports/WD11toLAD19byArea.csv")
```

## Catchment areas

```{r}

trustData2 = dpc$spim$getSARISummary()
trustData2 %>% filter(statistic=="hospital admission" & type=="incidence") %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forTJ-trust-admissions-by-age-",Sys.Date(),".csv"))


deaths = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(1,5,15,25,45,55,65,75,85), codeTypes = "LAD") #, subgroup = ons_pod)
deaths = deaths %>% tsp$aggregateGender()
deaths %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forTJ-lad-deaths-by-age-",Sys.Date(),".csv"))


cases = dpc$spim$getLineListIncidence(ageBreaks = c(1,5,15,25,45,55,65,75,85), codeTypes = "LAD",subgroup = NULL,filterExpr = asymptomatic_indicator != "Y") 
cases = cases %>% tsp$aggregateGender()
cases %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/forTJ-lad-cases-by-age-",Sys.Date(),".csv"))


# trustData2 %>% anti_join(arear::surgecapacity %>% select(trustId), by=c("code"="trustId")) %>% select(code,name) %>% distinct()
# RPC is specialist burns etc.
# ROD is only one that matters here
# arear::surgecapacity %>% dplyr::filter(hduBeds>0 & sector=="NHS Sector") %>% dplyr::group_by(trustId,trustName) %>% anti_join(trustData2, by=c("trustId"="code"))

sup = arear::surgecapacity %>% dplyr::filter(hduBeds>0 & sector=="NHS Sector") %>% dplyr::group_by(trustId,trustName) %>% semi_join(trustData2, by=c("trustId"="code"))
dem = arear::uk2019demographicsmap %>% filter(code %>% stringr::str_starts("E")) %>% left_join(arear::uk2019adultpopulation %>% select(-name,-codeType), by="code")

catch1 = arear::createCatchment(
  supplyShape = sup, 
  supplyIdVar = trustId, 
  supplyVar = acuteBeds,
  demandShape = dem,
  demandIdVar = code, 
  demandVar = population,
  outputMap = TRUE
)

catch1$crossMapping %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/ward-to-trust-catchment-",Sys.Date(),".csv"))
catch1$map %>% arear::saveShapefile("trust-catchment",dir="~/Dropbox/covid19/exports/")

map = catch1$map
ggplot(map) + geom_sf()

arear::preview(shape = catch1$map, poi = catch1$suppliers, shapeLabelGlue = "{trustName}",shapePopupGlue = "", poiLabelGlue = "{hospitalName}",poiPopupGlue = "")

```

## Areas - LSOA variant classifier

```{r}

devtools::load_all("~/Git/arear/")
lsoa11 = arear::getMap("LSOA11")

nn = arear::createNeighbourNetwork(lsoa11)

nn %>% readr::write_csv("~/Dropbox/covid19/exports/LSOA11RookNeighbours.csv")
```

## Cases by age group for Chris & Ellen

```{r}
tmp = dpc$spim$getLineListIncidence(ageBreaks = c(18,65,84),gender = FALSE,codeTypes = c("CTRY","NHSER")) 
tmp2 = tmp %>% dpc$demog$findDemographics()
tmp2 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/exports/cases-by-admissions-age-bands-",Sys.Date(),".csv"))

```

```{r}

tmp = dpc$spim$getLatestRawFile(dpc$spim$filter$trust,to = "~/tmp")


dpc$spim$getPaths(nocache=TRUE)
```
