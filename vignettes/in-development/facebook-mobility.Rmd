---
title: "Facebook mobility"
author: "Rob Challen"
date: "27/11/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all("~/Git/uk-covid-datatools/")
# ukcovidtools::setup()
ukcovidtools::reload()

devtools::load_all("~/Git/standard-print-output/")
standardPrintOutput::setDefaults()
```

```{r}
tmp = config::get()
s3 = fileProvider(tmp$secrets, "juniper")
files = s3$listAllFiles()
prevMap = files %>% filter(path %>% stringr::str_detect("Movement between Administrative Regions")) %>% filter(path %>% stringr::str_detect("\\/\\.",negate = TRUE))
```

```{r}

prevMap = prevMap %>% mutate(
  date = as.Date(path %>% stringr::str_extract("20[0-9]{2}-[0-9]{2}-[0-9]{2}")),
  time = path %>% stringr::str_extract("[0-9]{2}00")
)

prevMap2 = prevMap # %>% filter(date == max(date))

fb = s3$processFiles(paths = prevMap2$path,func = read.csv)
fb2 = fb %>% tidyr::unnest(cols=c(value)) %>% inner_join(prevMap2, by="path")

tmpFrom = bind_rows(
  fb2 %>% filter(country=="GB") %>% select(lon = start_lon, lat = start_lat, name = start_polygon_name, id=start_polygon_id),
  fb2 %>% filter(country=="GB") %>% select(lon = end_lon, lat = end_lat, name = end_polygon_name, id=end_polygon_id)
) %>% group_by(name,lat,lon,id) %>% count() 

tmpFrom %>% write.csv("~/Dropbox/covid19/facebook/facebookPolygons.csv")

```

```{r}

wdShape = dpc$demog$getDemographicsForShape(mapId = "WD11")
wdShape = wdShape %>% group_by(code,name) %>% summarise(count=sum(count))
wdShape = dpc$geog$getMap("WD11") %>% inner_join(wdShape, by=c("code","name"))

tmpFrom2 = tmpFrom %>% as.data.frame() %>% sf::st_as_sf(coords=c("lon","lat"), crs=4326)

map = dpc$geog$createCatchment(supplyShape = tmpFrom2 %>%group_by(name,id), supplyIdVar = id, supplyVar = n,
      demandId = "WD11", 
      demandShape = wdShape,
      demandIdVar = code, 
      demandVar = count,
      outputMap = TRUE
    )
```

```{r}

tmpFrom2 = tmpFrom %>% sf::st_as_sf(coords=c("lon","lat"), crs=4326)
ggplot()+geom_sf(data=dpc$geog$getMap("WD11"))+geom_sf(data=tmpFrom2,colour="red",size=0.5)

leaflet::leaflet() %>% leaflet::addTiles() %>% leaflet::addPolygons(data=map$map) %>% leaflet::addCircleMarkers(data=tmpFrom, lng = tmpFrom$lon, lat = tmpFrom$lat, color = "red")
# Its not a clean mapping from any of LAD, LSOA, MSOA, WD, 

ggplot(map$suppliedArea,aes(fill=as.factor(iteration)))+geom_sf(size=0.05,colour="grey50")+scale_fill_viridis_d()+geom_sf(data=map$map,colour="white",size=0.1,inherit.aes = FALSE,fill=NA)

#mapping = tmpFrom %>% dpc$geog$getContainedIn(outputMapId = "LSOA11",inputIdVar = start_polygon_id, outputIdVar = code) %>% distinct()

mapping %>% inner_join(tmpFrom %>% as.data.frame() %>% select(start_polygon_id,start_polygon_name) %>% distinct() ,by=c("from"="start_polygon_id")) %>% inner_join(dpc$geog$getMap("WD11") %>% as.data.frame() %>% select(name,code),by=c("to"="code"))


```



```{r}
tmp = dpc$spim$getSGeneLineList()
ll = dpc$spim$getLineList() 

#llp2 = ll %>% filter(pillar == "Pillar 2") %>% group_by(pillar,asymptomatic_indicator)
tmp3 = ll %>% mutate(FINALID = as.numeric(FINALID))


tmp3 = tmp3 %>% left_join(tmp, by="FINALID", suffix=c("",".sgene"))
tmp3 = tmp3 %>% group_by(FINALID) %>% arrange(specimen_date.sgene) %>% mutate(est.testNumber = row_number())

# How many do we have CT values for? & how many of those were repeat tests?
sGeneTestStatus = tmp3 %>% group_by(specimen_date,age,FINALID,NHSER_code,NHSER_name,LTLA_code,LTLA_name) %>% summarise(
  sGeneTested = all(!is.na(sgtf)),
  sGeneRepeats = n()
) %>% mutate(sGeneRepeats = sGeneRepeats-ifelse(sGeneTested,0,1))

sGeneTestStatus %>% group_by(NHSER_name,sGeneTested) %>% summarise(count = n()) %>% 
  mutate(percent = sprintf("%1.2f%%",count/sum(count)*100), col = ifelse(sGeneTested, "CT known", "CT unknown")) %>% ungroup() %>% 
  select(NHSER_name,col,percent) %>% pivot_wider(names_from=col,values_from=percent) %>% clipr::write_clip()

tmp3 %>% filter(!is.na(sgtf)) %>% group_by(est.testNumber,sgtf) %>% summarise(count=n()) %>% 
  mutate(percent = sprintf("%1.2f%%",count/sum(count)*100), col = ifelse(sgtf==1, "S-", "S+")) %>% ungroup() %>% 
  select(est.testNumber,col,percent) %>% pivot_wider(names_from=col,values_from=percent)

# pillar 2 testing kit changes don't affect
tmp6 = tmp3 %>% filter(!is.na(sgtf) & specimen_date > "2020-11-01")
tmp6 = tmp6 %>% mutate(pillar_2_testingkit = tolower(pillar_2_testingkit)) 
tmp6 %>% filter(specimen_date > as.Date("2020-12-15") & specimen_date < as.Date("2020-12-21")) %>% group_by(pillar_2_testingkit,sgtf) %>% summarise(count=n()) %>% 
  mutate(percent = sprintf("%1.2f%%",count/sum(count)*100), col = ifelse(sgtf==1, "S-", "S+"), N=sum(count)) %>% ungroup() %>% 
  select(pillar_2_testingkit,col,percent,N) %>% pivot_wider(names_from=col,values_from=percent)



```


```{r}
tmp2 = tmp%>% mutate(
  ORF1ab_L=ifelse(P2CH1CQ==0,40,P2CH1CQ),
  N_L=ifelse(P2CH2CQ==0,40,P2CH2CQ),
  S_L=ifelse(P2CH3CQ==0,40,P2CH3CQ),
  ORF1ab_R=ifelse(P2CH1CQ==0,NA,P2CH1CQ),
  N_R=ifelse(P2CH2CQ==0,NA,P2CH2CQ),
  S_R=ifelse(P2CH3CQ==0,NA,P2CH3CQ)
) %>% mutate(
  
  S_equiv = S_L>=40 & ORF1ab_L > 30 & N_L > 30 & ORF1ab_L < 40 & N_L < 40,
  S_pos = S_L<40,
  
  S_neg = S_L>=40 & ORF1ab_L < 30 & N_L < 30,
  ORF1ab_neg = S_L<30 & ORF1ab_L >= 40 & N_L < 30,
  N_neg = S_L<30 & ORF1ab_L < 30 & N_L >=40,
  
  S_neg_40 = S_L>=40 & ORF1ab_L < 40 & N_L < 40,
  S_neg_35 = S_L>=40 & ORF1ab_L < 35 & N_L < 35,
  S_neg_30 = S_L>=40 & ORF1ab_L < 30 & N_L < 30,
  S_neg_25 = S_L>=40 & ORF1ab_L < 25 & N_L < 25,
  S_neg_20 = S_L>=40 & ORF1ab_L < 20 & N_L < 20,
  S_neg_15 = S_L>=40 & ORF1ab_L < 15 & N_L < 15,
  S_neg_10 = S_L>=40 & ORF1ab_L < 10 & N_L < 10
  
)

tmp4 =  tmp2 %>% left_join(ll %>% mutate(FINALID=as.numeric(FINALID)),by="FINALID",suffix=c("",".pat")) %>%
          pivot_longer(cols = 
                          #c(S_neg,ORF1ab_neg,N_neg)
                          #c(S_neg,S_equiv,S_pos,S_neg_25,S_neg_35)
                          c(S_neg_40,S_neg_35,S_neg_30,S_neg_25,S_neg_20,S_neg_15,S_neg_10)
                        , names_to="dropout", values_to="status") %>% 
          group_by(NHSER_name,dropout,specimen_date,status) %>% 
          summarise(count=n()) %>% 
          mutate(percent=count/sum(count)*100) %>%
          mutate(binom::binom.confint(count, sum(count), conf.level = 0.95, methods = "wilson"))

ggplot(tmp4 %>% filter(status==TRUE),aes(x=specimen_date,y=percent,ymin=lower*100,ymax=upper*100)
                        )+geom_ribbon(alpha=0.4,mapping=aes(fill=dropout))+geom_line(mapping=aes(colour=dropout))+facet_wrap(vars(NHSER_name))

# Beta distribution with parameters (x + 1/2, n â€“ x + 1/2).

# a = ggplot(tmp2,aes(x=P2CH1CQ,y=P2CH3CQ,colour=sgtf))+geom_point()
# b = ggplot(tmp2,aes(x=P2CH2CQ,y=P2CH3CQ,colour=sgtf))+geom_point()
# c = ggplot(tmp2,aes(x=P2CH1CQ,y=P2CH2CQ,colour=sgtf))+geom_point()
# a+b+c+patchwork::plot_layout(ncol=3)

```

proportion of S neg dropout seems to be plateau-ing (sic?) on most recent data. The level depends on the definition of S negativity - in terms of the CT values of the other genes needed to define a positive - the "standard" definition is S_neg_30. Which gives the dropout at around 70% of the total. This could be successful prevention of spread... or maybe indication that 


```{r}
tmp5 = tmp2 %>% mutate(x = specimen_date,y = as.integer(ORF1ab_L)) %>% group_by(x,y) %>% mutate(z=n())
ggplot(tmp5, aes(x=x,y=y,fill = z))+geom_tile()

```


```{r}



if(nrow(llp2) != nrow(tmp3)) {
  warning("duplicates in ")
  byPatient = tmp3 %>% filter(!is.na(sgtf)) %>% group_by(FINALID) %>% summarise(sgtfResults = n_distinct(sgtf), sgtf=mean(sgtf), sgtfTests = n()) 
  duplicates = byPatient %>% filter(sgtfTests > 1)
  # of all patients most have had only one test sequenced. A small number have had a lot.
  byPatient %>% group_by(sgtfTests) %>% count() %>% ungroup() %>% mutate(percent = sprintf("%1.2f%%",n/sum(n)*100))
  duplicates %>% group_by(sgtfResults) %>% count() %>% ungroup() %>% mutate(percent = sprintf("%1.2f%%",n/sum(n)*100))
  
  # excluding patients with inconsistent results 20% are S-
  # in the subgroup that have repeat tests fewer - 9% are S-. If repeat tests is a function of time and S- are more recent then this is explainable by right censoring.
  byPatient %>% filter(sgtfResults == 1) %>% group_by(sgtf) %>% count() %>% ungroup() %>% mutate(percent = sprintf("%1.2f%%",n/sum(n)*100))
  duplicates %>% filter(sgtfResults == 1) %>% group_by(sgtf) %>% count() %>% ungroup() %>% mutate(percent  = sprintf("%1.2f%%",n/sum(n)*100))
  
  
  # Find patients that swtich from S+ to S-
  tmp4 = tmp3 %>% arrange(FINALID,specimen_date.sgene) %>% mutate(
    lead.FINALID = lead(FINALID),
    lead.P2CH3CQ = lead(P2CH3CQ),
    lead.P2CH1CQ = lead(P2CH1CQ),
    lead.P2CH2CQ = lead(P2CH2CQ),
    lead.sgtf = lead(sgtf),
    lead.specimen_date.sgene = lead(specimen_date.sgene),
    lead.CDR_Specimen_Request_SK = lead(CDR_Specimen_Request_SK)
  ) %>% filter(lead.FINALID == FINALID)
  
  transitions = tmp4 %>% filter(P2CH3CQ > 0 & lead.P2CH3CQ == 0)
  
  reinfections = transitions %>% 
    filter((P2CH3CQ > 0 & P2CH3CQ < 29) & (P2CH1CQ > 0 & P2CH1CQ < 29) & (P2CH2CQ > 0 & P2CH2CQ < 29)) %>% # was it definitely a previous S+ infection
    filter((lead.P2CH1CQ > 0 & lead.P2CH1CQ < 29) & (lead.P2CH2CQ > 0 & lead.P2CH2CQ < 29)) %>%  # was it definitely a previous S+ infection
    filter(as.numeric(lead.specimen_date.sgene-specimen_date.sgene)>12) #%>% # was it > 12 days later
    #View()
  
  reinfections %>% readr::write_csv("~/tmp/reinfections.csv")
  
  revTransitions = tmp4 %>% filter(P2CH3CQ == 0 & lead.P2CH3CQ > 0)
  
  revReinfections = transitions %>% 
    filter((P2CH1CQ > 0 & P2CH1CQ < 29) & (P2CH2CQ > 0 & P2CH2CQ < 29)) %>% # was it definitely a previous S- infection
    filter((lead.P2CH3CQ > 0 & lead.P2CH3CQ < 29) & (lead.P2CH1CQ > 0 & lead.P2CH1CQ < 29) & (lead.P2CH2CQ > 0 & lead.P2CH2CQ < 29)) %>%  # was it definitely a subsequent S+ infection
    filter(as.numeric(lead.specimen_date.sgene-specimen_date.sgene)>12) %>% # was it > 12 days later
    View()
  
  
  repeats = tmp4 %>% mutate(transition = paste0(sgtf,"-",lead.sgtf), interval=as.numeric(lead.specimen_date.sgene-specimen_date.sgene))
  repeats %>% filter(interval < 10) %>% group_by(transition) %>% count() %>% readr::write_csv("~/tmp/transitions.csv")
  ggplot(repeats,aes(x=transition,y=interval))+geom_violin()
}
```

```{r}
tmp3 = tmp3 %>% mutate(SgeneResult = ifelse(is.na(sgtf),"Unknown",SgeneResult))

summary = tmp3 %>% group_by(pillar,NHSER_name,SgeneResult) %>% summarise(n=n(),maxDate=max(specimen_date))
#summary %>% View()
truncate = min(summary$maxDate)

tmp3 = tmp3 %>% filter(specimen_date < truncate)

# Some difference between Aystmptomatic and symptomatic
tmp3 %>% filter(asymptomatic_indicator != "U") %>% 
  group_by(asymptomatic_indicator,SgeneResult) %>% count() %>% 
  pivot_wider(names_from = SgeneResult, values_from = n) %>% mutate(percentSNeg = Negative/(Negative+Positive)*100) %>% clipr::write_clip()

mutationIncidence = tsp$spim$getLineListIncidence(ll=tmp3,ageBreaks = c(5,17,23,60,75), subgroup = SgeneResult,nocache=TRUE) %>% tsp$aggregateGender()

if(mutationIncidence %>% filter(codeType=="NHSER") %>% pull(value) %>% sum() != nrow(tmp3)) stop("incidence error")

mutationIncidence2 = mutationIncidence %>% mutate(value) %>% pivot_wider(names_from = subgroup,values_from=value)  %>%
  mutate(
    Positive = ifelse(is.na(Positive),0,Positive),
    Negative = ifelse(is.na(Negative),0,Negative),
    Unknown = ifelse(is.na(Unknown),0,Unknown)
  )

mutationIncidence2 = mutationIncidence2 %>% covidStandardGrouping() %>% arrange(date) %>% mutate(
  Roll.Negative = stats::filter(Negative,filter=rep(1,7),sides=1),
  Roll.Positive = stats::filter(Positive,filter=rep(1,7),sides=1),
  Roll.Unknown = stats::filter(Unknown,filter=rep(1,7),sides=1)
)

mutationIncidence2 = mutationIncidence2 %>% mutate(
  sequenced = 1-Roll.Unknown/(Roll.Unknown+Roll.Positive+Roll.Negative)
  #sequenced.CI.0.025 = binom.confint(Roll.Unknown, Roll.Unknown+Roll.Positive+Roll.Negative, )
  #sequenced.CI.0.975
)

ggplot(mutationIncidence2 %>% filter(name !="Unknown (England)" & ageCat != "unknown" & date > "2020-09-01"), aes(x=date,y=sequenced,colour=ageCat))+geom_line()+facet_wrap(vars(name))+ylab("P(S gene status reported)")

```

```{r}



guestimateIncidenceAge = mutationIncidence2 %>% mutate(
  Positive.estimate = (Roll.Negative+Roll.Positive+Roll.Unknown) * Roll.Positive/(Roll.Negative+Roll.Positive),
  Negative.estimate = (Roll.Negative+Roll.Positive+Roll.Unknown) * Roll.Negative/(Roll.Negative+Roll.Positive)
  ) %>% pivot_longer(cols=c(Positive.estimate, Negative.estimate),names_to = "subgroup", values_to="value") %>% select(-Negative, -Positive, -Unknown, -Roll.Negative, -Roll.Positive, -Roll.Unknown, sequenced) %>%
  mutate(value=ifelse(is.nan(value),NA,value))

guestimateIncidenceAgeCTRY = guestimateIncidenceAge %>% filter(codeType=="CTRY" & ageCat != "unknown")
```

```{r}
(guestimateIncidenceAgeCTRY %>% dpc$demog$findDemographics() %>% tsp$plotIncidenceQuantiles(colour = subgroup,denominatorExpr = population/1000000))+facet_wrap(vars(ageCat))+scale_y_continuous(trans="log1p", breaks = c(0,2,5,20,50,200,500,2000,5000))
```

```{r}
(guestimateIncidenceAgeCTRY %>% dpc$demog$findDemographics() %>% tsp$plotGrowthRate(colour = subgroup,denominatorExpr = population/1000000))+facet_wrap(vars(ageCat))
```

```{r}

mutationIncidence3 = tsp$spim$getLineListIncidence(ll=tmp3,subgroup = SgeneResult,nocache=TRUE) %>% tsp$aggregateGender()

if(mutationIncidence %>% filter(codeType=="NHSER") %>% pull(value) %>% sum() != nrow(tmp3)) stop("incidence error")

mutationIncidence4 = mutationIncidence3 %>% mutate(value) %>% pivot_wider(names_from = subgroup,values_from=value)  %>%
  mutate(
    Positive = ifelse(is.na(Positive),0,Positive),
    Negative = ifelse(is.na(Negative),0,Negative),
    Unknown = ifelse(is.na(Unknown),0,Unknown)
  )

mutationIncidence4 = mutationIncidence4 %>% filter(date < "2020-12-07") %>% covidStandardGrouping() %>% arrange(date) %>% mutate(
  Roll.Negative = stats::filter(Negative,filter=rep(1,7),sides=1),
  Roll.Positive = stats::filter(Positive,filter=rep(1,7),sides=1),
  Roll.Unknown = stats::filter(Unknown,filter=rep(1,7),sides=1)
)

mutationIncidence4 = mutationIncidence4 %>% mutate(
  sequenced = 1-Roll.Unknown/(Roll.Unknown+Roll.Positive+Roll.Negative)
  #sequenced.CI.0.025 = binom.confint(Roll.Unknown, Roll.Unknown+Roll.Positive+Roll.Negative, )
  #sequenced.CI.0.975
)
guestimateIncidence = mutationIncidence4 %>% mutate(
  Positive.estimate = (Roll.Negative+Roll.Positive+Roll.Unknown) * Roll.Positive/(Roll.Negative+Roll.Positive),
  Negative.estimate = (Roll.Negative+Roll.Positive+Roll.Unknown) * Roll.Negative/(Roll.Negative+Roll.Positive)
  ) %>% pivot_longer(cols=c(Positive.estimate, Negative.estimate),names_to = "subgroup", values_to="value") %>% select(-Negative, -Positive, -Unknown, -Roll.Negative, -Roll.Positive, -Roll.Unknown, sequenced) %>%
  mutate(value=ifelse(is.nan(value),NA,value))
```

```{r}
(guestimateIncidence %>% dpc$demog$findDemographics() %>% tsp$plotIncidenceQuantiles(colour = subgroup,denominatorExpr = population/1000000))+facet_wrap(vars(name))+scale_y_continuous(trans="log1p", breaks = c(0,2,5,20,50,200,500,2000,5000))
```


```{r}
(guestimateIncidence %>% filter(name != "Unknown (England)") %>% tsp$plotGrowthRate(colour = subgroup))+facet_wrap(vars(name))
```


## COG Data

```{r}

cogData = NULL
cogDate = Sys.Date()
while (identical(cogData,NULL)) {
  tryCatch({
    cogData = readr::read_csv(paste0("http://cog-uk-microreact.s3.climb.ac.uk/",cogDate,"/cog_metadata_microreact_public.csv"))
  }, error = function(e) {
    #message(cogDate)
    cogDate <<- cogDate-1
  })
}

ggplot(cogData %>% filter(lineage %>% stringr::str_starts("B.1.1.7")),aes(x=sample_date))+geom_histogram()

cogSf = cogData %>% filter(country=="UK" & !is.na(latitude) & !is.na(longitude) & latitude>0) %>% group_by(latitude,longitude) %>% count() %>% sf::st_as_sf(coords=c("longitude","latitude")) %>% mutate(name=n, code=n)

names(dpc$geog$sources$maps)
# "WD11"      "LSOA11"    "MSOA11"    "DZ11"      "HB19"      "LHB19"     "CTYUA19"   "LAD19"     "LAD20"     "CCG20"     "NHSER20"   "PHEC16"    "CTRY19"    "LGD12"     "OUTCODE"   "ISO3166_2" "ISO3166_3"

phec16 = dpc$geog$getMap("ISO3166_2",nocache=TRUE)
#ggplot()+geom_sf(data = phec16)+geom_sf(data = cogSf)

dpc$geog$preview(mapId="NHSER20",poi = cogSf)

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
