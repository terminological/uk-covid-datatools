---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
devtools::load_all("~/Git/uk-covid-datatools/")
#ukcovidtools::setup("~/Git/uk-covid-datatools/config.yml")
ukcovidtools::reload("~/Git/uk-covid-datatools/config.yml")
devtools::load_all("~/Git/arear")
options("arear.cache.dir"="~/Dropbox/covid19/catchment-areas/cache/")
devtools::load_all("~/Git/standard-print-output/")
standardPrintOutput::setDefaults()

# trustData = dpc$datasets$getPHEApiNHSTrusts()
# trustData2 = trustData %>% dpc$codes$findNamesByCode()
# trustData2 %>% filter(is.na(name)) %>% group_by(code,name.original,statistic,type) %>% summarise(value=max(value)) %>% View()

trustData = dpc$spim$getSARISummary(nocache=TRUE)

trustData2 = trustData %>% filter(type=="incidence" & statistic=="hospital admission") %>% tsp$aggregateAge()



```

```{r}

tmp = arear::surgecapacity %>% 
  #dplyr::filter(hduBeds>0 & sector=="NHS Sector") %>% 
  dplyr::group_by(trustId,trustName) %>% anti_join(trustData2, by=c("trustId"="code"))
tmp2 = trustData2 %>% anti_join(arear::surgecapacity, by=c("code"="trustId")) %>% select(code,name) %>% distinct()

#trustData %>% filter(code %in% c("RDZ","R0D","RD3") & !is.na(value)) %>% View()


sup = arear::surgecapacity %>% 
  #dplyr::filter(hduBeds>0 & sector=="NHS Sector") %>% 
  dplyr::group_by(trustId,trustName) %>% semi_join(trustData2, by=c("trustId"="code"))
dem = arear::uk2019demographicsmap %>% 
  filter(code %>% stringr::str_starts("E")) %>% 
  left_join(arear::uk2019adultpopulation %>% select(-name,-codeType), by="code")

catch1 = arear::createCatchment(
  supplyShape = sup, 
  supplyIdVar = trustId, 
  supplyVar = acuteBeds,
  demandShape = dem,
  demandIdVar = code, 
  demandVar = population,
  outputMap = TRUE
)

map = catch1$map
ggplot(map) + geom_sf()

#trustDemog = dpc$demog$getDemographicsForShape(outputShape = map,,ageBreaks = c(6,19,23,65,75))
```

```{r}

trustRt = trustData2 %>% filter(codeType == "NHS trust" & type =="incidence" & statistic=="hospital admission") %>% tsp$estimateRtQuick()

trustGrowth = trustData2 %>% filter(codeType == "NHS trust" & type =="incidence" & statistic=="hospital admission") %>% tsp$estimateGrowthRate()

tmp = map %>% left_join(trustGrowth %>% filter(date == max(date)-4), by=c("trustId"="code"))

ggplot(tmp)+geom_sf(aes(fill=Growth.poisson)) + scale_fill_distiller(palette = "RdGy", name="growth rate", oob=scales::squish, lim=c(-0.10,0.10))

```

```{r}
demogMap = dpc$demog$getDemographicsForShape(mapId = "LAD19",ageBreaks = c(6,19,23,65,75))

ladMap = dpc$geog$getMap("LAD19") %>% inner_join(demogMap %>% ungroup() %>% select(code, ageCat,count), by="code") %>% group_by(code) %>% mutate(percent = count/sum(count)) %>% ungroup()

ggplot(ladMap, aes(x=percent))+geom_density()

pSchool = 
  ggplot(ladMap %>% filter(ageCat=="6-18"), aes(fill=percent))+geom_sf()+scale_fill_viridis_c(limits=c(0.06,0.09),oob=scales::squish) #+ facet_wrap(vars(ageCat))
pSchool %>% standardPrintOutput::saveFullPageFigure("~/tmp/UKSchoolage")
```


```{r}

tmp = ladMap %>% group_by(ageCat) %>% mutate(pPercent = pnorm(percent,mean = mean(percent),sd=sd(percent))) %>% ungroup()

pAll = 
  ggplot(tmp, aes(fill=pPercent-0.5))+geom_sf(size = 0.05)+scale_fill_gradient2(limits=c(-0.5,0.5),oob=scales::squish,low = "grey60", high="orange",mid="white",midpoint = 0) + facet_wrap(vars(ageCat),nrow = 1)+standardPrintOutput::narrowAndTall()+labs(fill="Relative deviation from mean")
pAll %>% standardPrintOutput::saveFigure("~/tmp/UKAges",maxWidth = 12,maxHeight = 5)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
