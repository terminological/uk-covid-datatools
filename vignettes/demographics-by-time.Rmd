---
title: "COVID-19 age breakdown"
author: "Rob Challen"
date: '`r format(Sys.Date(), "%d-%m-%Y")`'
output:
  beamer_presentation:
    slide_level: 2
    theme: "Singapore"
    colortheme: "seagull"
classoption: "aspectratio=169"
knit: (function(inputFile, encoding,...) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = paste0("~/Dropbox/covid19/current-rt/",Sys.Date()), output_file=paste0('covid-demographics-',Sys.Date(),'.pdf')) })
# output: 
#   ioslides_presentation:
#     widescreen: true
#     smaller: true
#     css: ~/Git/uk-covid-datatools/vignettes/ioslides.css
# knit: (function(inputFile, encoding,...) {
#   rmarkdown::render(inputFile, encoding = encoding, output_dir = "~/Dropbox/covid19/by-age", output_file=paste0('covid-demograpics-',Sys.Date(),'.html') ) })
fig_width: 7
fig_height: 5
out.width: "100%"
bibliography: current-rt.bib
csl: sage-vancouver.csl
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

devtools::load_all("~/Git/standard-print-output/")
devtools::load_all("~/Git/uk-covid-datatools/")
library(tidyverse)
library(patchwork)
library(rgdal)
library(ggplot2)
library(ggspatial)
library(rgeos)
library(maptools)
library(patchwork)
library(sp)
library(sf)

ggplot2::theme_set(standardPrintOutput::defaultFigureLayout())

standardPrintOutput::setDefaults()

cap = list(
  fig = captioner::captioner(prefix="Figure"),
  tab = captioner::captioner(prefix="Table"),
  sfig = captioner::captioner(prefix="Supplemental figure"),
  stab = captioner::captioner(prefix="Supplemental table")
)

ref = list(
  fig = function(name) cap$fig(name,display="cite"),
  tab = function(name) cap$tab(name,display="cite"),
  sfig = function(name) cap$sfig(name,display="cite"),
  stab = function(name) cap$stab(name,display="cite")
)

ukcovidtools::setup()
```

## Authors

Robert Challen ^1,2^;  Krasimira Tsaneva-Atanasova ^1,3,5^; Ellen Brooks-Pollock^4^; Leon Danon ^3,5^

1) EPSRC Centre for Predictive Modelling in Healthcare, University of Exeter, Exeter, Devon, UK.
2) Taunton and Somerset NHS Foundation Trust, Taunton, Somerset, UK.
3) The Alan Turing Institute, British Library, 96 Euston Rd, London NW1 2DB, UK.
4) Bristol Medical School, Population Health Sciences, University of Bristol, Bristol, UK
5) Data Science Institute, College of Engineering, Mathematics and Physical Sciences, University of Exeter, Exeter, UK. 

Report: `r Sys.Date()`

```{r}
events = dpc$datasets$getSignificantDates(nocache=TRUE) %>% filter(Label %in% c("Hotels and bars reopen","End summer term","Start autumn term","Start univerity term","England 2nd lockdown"))
startDate = "2020-12-01"
```

```{r}
#casesPerPillar = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = pillar)
casesPerSymptomatic = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = asymptomatic_indicator)
#casesPerEthnicity = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = ethnicity_final)
#casesPerIMD = dpc$spim$getLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = imd_decile)

breakdown111 = dpc$spim$getOneOneOneIncidence(dateFrom = as.Date(startDate))

#deathsPerResidence = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = residence_type)
#deathsPerEthicity = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85),subgroup = ethnicity_final)
deaths = dpc$spim$getDeathsLineListIncidence(ageBreaks = c(5,15,25,35,45,55,65,75,85), deathOrReport = "death")

others = dpc$spim$getSPIMextract()

icuAdmissions = others %>% filter(source == "chess_icu_admissions" & !is.na(ageCat) & codeType %in% c("CTRY","NHSER"))
admissions = others %>% filter(source %in% c("hospital_inc","hospital_inc_new") & !is.na(ageCat) & codeType %in% c("CTRY","NHSER"))
```

```{r}
## data for TJ
# tmp1 = casesPerSymptomatic %>% filter(subgroup != "Y" & ageCat!="unknown")  %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()
# tmp2 = admissions %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
# tmp3 = icuAdmissions %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
# tmp4 = deaths  %>% mutate(ageCat = as.character(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
# tmp5 = bind_rows(tmp1,tmp2,tmp3,tmp4) %>% tsp$logIncidenceStats() %>% filter(date > "2020-03-23")
# tmp5 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/by-age/symptomaticCasesAdmissionsAndDeaths_AgeAndNHSER_GrowthRate_",Sys.Date(),".csv"))

## data foe Ellen
# tmp = casesPerSymptomatic %>% filter(codeType %in% c("CTRY","NHSER") & subgroup != "Y" & ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()
# tmp2 = tmp %>% tsp$logIncidenceStats(growthRateWindow = 14) %>% tsp$estimateRt(window = 14)
# tmp2 %>% readr::write_csv(path = paste0("~/Dropbox/covid19/by-age/symptomaticCases_AgeAndRegionStratifiedRtAndGrowthRate_",Sys.Date(),".csv"))
```


```{r}
# negatives = dpc$spim$getNegatives()
# 
# positivityByPillarAndAge = negatives %>% tsp$aggregateGender()  %>% filter(codeType == "CTRY") %>% rename(neg=value) %>% inner_join(cases %>% tsp$aggregateGender() %>% select(date,codeType,subgroup,ageCat,gender,pos=value), by=c("date","codeType","subgroup","ageCat","gender"), suffix=c(".neg",".pos")) %>%  mutate(value = pos/(pos+neg), ageCat = tsp$ageCatToFactor(ageCat)) 
# 
# volumesByPillarAndAge = negatives %>% tsp$aggregateGender()  %>% filter(codeType == "CTRY") %>% rename(neg=value) %>% inner_join(cases %>% tsp$aggregateGender() %>% select(date,codeType,subgroup,ageCat,gender,pos=value), by=c("date","codeType","subgroup","ageCat","gender"), suffix=c(".neg",".pos")) %>%  mutate(value = pos+neg, ageCat = tsp$ageCatToFactor(ageCat)) %>% dpc$demog$findDemographics()


```



<!-- ## Gender differences -->

<!-- ```{r} -->
<!-- tmp = casesPerSymptomatic %>% filter(codeType == "CTRY") %>% tsp$aggregateSubgroup() %>% dpc$demog$findDemographics()  -->
<!-- tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=gender) + facet_wrap(vars(ageCat)) + scale_y_continuous(trans="log1p") -->

<!-- ``` -->

<!-- ## Asymptomatic and symptomatic case numbers -->

<!-- ```{r} -->
<!-- tmp = casesPerSymptomatic %>% filter(codeType == "CTRY") %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()  -->
<!-- p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=subgroup, events = events,dates = startDate) + facet_wrap(vars(ageCat),ncol=4) + scale_y_continuous(trans="log1p",breaks = c(1,10,20,50,100,200,500,1000))+ylab("cases per 1M per day")+guides(colour=guide_legend("asymptomatic")) -->

<!-- ``` -->

<!-- ## Asymptomatic and symptomatic case numbers  -->

<!-- ```{r} -->
<!-- tmp = casesPerSymptomatic %>% filter(codeType == "NHSER" & name=="London") %>% tsp$aggregateGender() %>% dpc$demog$findDemographics()  -->
<!-- p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=subgroup, events = events,dates = startDate) + facet_wrap(vars(ageCat),ncol=4) + scale_y_continuous(trans="log1p",breaks = c(1,10,20,50,100,200,500,1000))+ylab("cases per 1M per day")+guides(colour=guide_legend("asymptomatic")) -->
<!-- p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_CasesBySymptoms") -->

<!-- ``` -->

## Materials

* Cases: Pillar 1 & 2 excluding asymptomatics from linelists
* Admissions: Sum of "hospital_inc" & "hospital_inc_new" fields (All_SPIM_trust)
* ICU admissions: "chess_icu_admissions" (All_SPIM_trust)
* Deaths: Linelist
* 111 calls: 111 linelists
* N.B. No adjustments made for reporting delays

## Symptomatic covid positive cases by age

```{r}
tmp = casesPerSymptomatic %>% filter(codeType == "CTRY" & subgroup != "Y" & ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat),ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500,2000))+ylab("cases per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/CTRY_SymptomaticCasesByAge")
```

## Symptomatic covid positive cases by age and region

```{r}
tmp = casesPerSymptomatic %>% filter(codeType == "NHSER" & subgroup != "Y" & name != "Unknown (England)" & ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat),ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("cases per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_SymptomaticCasesByAgeAndRegion")

```

## Symptomatic covid positive cases by region and age

```{r}
tmp = casesPerSymptomatic %>% filter(codeType == "NHSER" & subgroup != "Y" & name != "Unknown (England)" & ageCat!="unknown") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=ageCat, events = events,dates = startDate) + facet_wrap(vars(name),ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("cases per 1M per day")+guides(colour=guide_legend("age")) + scale_color_viridis_d()
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_SymptomaticCasesByRegionAndAge")

```


## Hospital admissions and in hospital COVID by age

```{r}
tmp = admissions %>% filter(codeType == "CTRY") %>% mutate(ageCat = factor(ageCat,c("0-5","6-17","18-64","65-84","85+"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat), ncol=3) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("admissions per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/CTRY_AdmissionsByAge")
```

## Hospital admissions and in hospital COVID by age and region

```{r}
tmp = admissions %>% filter(codeType == "NHSER" & name != "Unknown (England)" & ageCat!="unknown") %>% mutate(ageCat = factor(ageCat,c("0-5","6-17","18-64","65-84","85+"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat),ncol=3) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("admissions per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_AdmissionsByAgeAndRegion")
```

## Hospital admissions and in hospital COVID by region and age

```{r}
tmp = admissions %>% filter(codeType == "NHSER" & name != "Unknown (England)" & ageCat!="unknown") %>% mutate(ageCat = factor(ageCat,c("0-5","6-17","18-64","65-84","85+"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=ageCat, events = events,dates = startDate, ylim = c(0,500)) + facet_wrap(vars(name),ncol=4) + scale_color_viridis_d()+
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("admissions per 1M per day")+guides(colour=guide_legend("age"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_AdmissionsByRegionAndAge")
```

## ICU admissions by age

```{r}
tmp = icuAdmissions %>% filter(codeType == "CTRY")  %>% mutate(ageCat = tsp$ageCatToFactor(ageCat,c("<1","1-4","5-14","15-24","25-44","45-54","55-64","65-74","75-84",">85"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat)) + 
  scale_y_continuous(trans="log1p",breaks = c(2,5,20,50,200,500))+ylab("ICU admissions per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/CTRY_IcuAdmissionsByAge")
```

## ICU admissions by age and region

```{r}
tmp = icuAdmissions %>% filter(codeType == "NHSER") %>% mutate(ageCat = tsp$ageCatToFactor(ageCat,c("<1","1-4","5-14","15-24","25-44","45-54","55-64","65-74","75-84",">85"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat)) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("ICU admissions per 1M per day")+guides(colour=guide_legend("region"))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_IcuAdmissionsByAgeAndRegion")
```

## ICU admissions by region and age

```{r}
tmp = icuAdmissions %>% filter(codeType == "NHSER") %>% mutate(ageCat = tsp$ageCatToFactor(ageCat,c("<1","1-4","5-14","15-24","25-44","45-54","55-64","65-74","75-84",">85"))) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=ageCat, events = events,dates = startDate) + facet_wrap(vars(name)) + 
  scale_y_continuous(trans="log1p",breaks = c(2,5,20,50,200,500))+ylab("ICU admissions per 1M per day")+guides(colour=guide_legend("age")) +scale_colour_viridis_d()
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_IcuAdmissionsByRegionAndAge")
```

## Deaths

* When subdivided into small age groups by regions death data must be interpreted with caution
* Long and variable reporting delays can affect tail of time series.
* This data is provided as-is

## Deaths

```{r}
tmp = deaths %>% filter(codeType == "CTRY") %>% mutate(ageCat = tsp$ageCatToFactor(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat), ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("deaths per 1M per day")+guides(colour=guide_legend("region"))#+coord_cartesian(ylim=c(0,200))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/CTRY_DeathsByAge")
```

## Deaths by age and region

```{r}
tmp = deaths %>% filter(codeType == "NHSER" & ageCat!="unknown") %>% mutate(ageCat = tsp$ageCatToFactor(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=name, events = events,dates = startDate) + facet_wrap(vars(ageCat), ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("deaths per 1M per day")+guides(colour=guide_legend("region"))#+coord_cartesian(ylim=c(0,500))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_DeathsByAgeAndRegion")
```

## Deaths by region and age

```{r}
tmp = deaths %>% filter(codeType == "NHSER" & ageCat!="unknown") %>% mutate(ageCat = tsp$ageCatToFactor(ageCat)) %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$aggregateSource() %>% dpc$demog$findDemographics() 
p = tmp %>% tsp$plotIncidenceQuantiles(denominatorExpr = population/1000000,colour=ageCat, events = events,dates = startDate) + facet_wrap(vars(name), ncol=4) + 
  scale_y_continuous(trans="log1p",breaks = c(5,20,50,200,500))+ylab("deaths per 1M per day")+guides(colour=guide_legend("age"))+scale_color_viridis_d()#+coord_cartesian(ylim=c(0,500))
p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_DeathsByRegionAndAge")
```




<!-- ## Acute outcome 111 calls -->

<!-- ```{r} -->
<!-- tmp = dpc$spim$getOneOneOneIncidence(dateFrom = as.Date(startDate)) %>%  -->
<!--   tsp$aggregateGeography(targetCodeTypes = "CTRY",keepOriginal = FALSE) %>% #tsp$logIncidenceStats(growthRateWindow = 14,smoothingWindow = 21) %>% -->
<!--   filter(subgroup %in% c("urgent clinical review", "emergency ambulance")) %>% -->
<!--   tsp$aggregateSubgroup() %>% -->
<!--   mutate(ageCat = ageCat %>% tsp$ageCatToFactor(ageLabels = c("<1","1-4","5-14","15-24","25-44","45-54","55-64","65-74","75-84","85+","Unknown"))) %>%  -->
<!--   dpc$demog$findDemographics() %>%  -->
<!--   filter(!ageCat %in% c("<1","Unknown"))  -->

<!-- p = tsp$plotIncidenceQuantiles(tmp, denominatorExpr = population/1000000, events = events, colour=name)+ -->
<!--     facet_wrap(vars(ageCat))+ -->
<!--     scale_y_continuous(trans="log1p", breaks = c(5,20,50,200,500,2000,5000))+ylab("per 1M per day") -->

<!-- p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/CTRY_111CallsByAge") -->
<!-- ``` -->

<!-- ## Acute outcome 111 calls by region -->

<!-- ```{r} -->
<!-- tmp = dpc$spim$getOneOneOneIncidence(dateFrom = as.Date(startDate)) %>%  -->
<!--   tsp$aggregateGeography(targetCodeTypes = "NHSER",keepOriginal = FALSE) %>% tsp$logIncidenceStats(growthRateWindow = 14,smoothingWindow = 21) %>% -->
<!--   filter(subgroup %in% c("urgent clinical review", "emergency ambulance")) %>% -->
<!--   tsp$aggregateSubgroup() %>% -->
<!--   mutate(ageCat = ageCat %>% tsp$ageCatToFactor(ageLabels = c("<1","1-4","5-14","15-24","25-44","45-54","55-64","65-74","75-84","85+","Unknown"))) %>%  -->
<!--   dpc$demog$findDemographics() %>%  -->
<!--   filter(!ageCat %in% c("<1","Unknown"))  -->

<!-- p = tsp$plotIncidenceQuantiles(tmp, denominatorExpr = population/1000000, events = events, colour=name)+ -->
<!--     facet_wrap(vars(ageCat))+ -->
<!--     scale_y_continuous(trans="log1p", breaks = c(0,5,15,50,150,500,1500,5000,15000))+ylab("per 1M per day") -->

<!-- p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/NHSER_111CallsByAge") -->
<!-- ``` -->

<!-- ## University age vs gen pop cases -->

<!-- ```{r} -->
<!-- events2 = dpc$datasets$getSignificantDates(nocache=TRUE) %>% filter(Label %in% c("Start autumn term","Start univerity term","Testing capacity limited")) -->

<!-- uniVsRestCasesPerSymptomatic = dpc$spim$getLineListIncidence(ageBreaks = c(6,11,18,23,60,75),subgroup = asymptomatic_indicator) %>% filter(ageCat !="unknown") %>% tsp$aggregateGender() %>% dpc$demog$findDemographics() -->
<!-- p = (uniVsRestCasesPerSymptomatic %>% filter(codeType=="CTRY") %>% tsp$plotIncidenceQuantiles(colour = subgroup, denominatorExpr = population/1000000, dates = "2020-08-01", events = events2)) + facet_wrap(vars(ageCat)) + scale_y_continuous(trans="log1p", breaks = c(0,5,15,50,150,500,1500,5000,15000))+guides(color=guide_legend("asymptomatic")) -->
<!-- p %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/UniversityCases") -->
<!-- ``` -->

<!-- ## University age vs gen pop growth rate (symptomatics) -->

<!-- ```{r} -->
<!-- totalUni = uniVsRestCasesPerSymptomatic %>% filter(subgroup!="Y") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% dpc$demog$findDemographics() -->
<!-- p2 = totalUni %>% filter(codeType=="CTRY") %>% tsp$logIncidenceStats(growthRateWindow = 14) %>% tsp$adjustGrowthRateDates() %>%  tsp$plotWindowedGrowthRate(dates = "2020-08-01", events = events2) + facet_wrap(vars(ageCat)) -->
<!-- # tsp$estimateRt(window = 14) %>%  tsp$plotRt(dates = "2020-08-01", events = events2) + facet_wrap(vars(ageCat)) -->
<!-- p2 %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/UniversityRt") -->
<!-- ``` -->



<!-- ```{r} -->

<!-- dmg = dpc$demog$getDemographicsForShape(mapId = "LAD19",ageBreaks = c(6,11,18,23,60,75), combineGenders = TRUE) -->

<!-- tmp = dpc$spim$getLineListIncidence(ageBreaks = c(6,11,18,23,60,75),subgroup = asymptomatic_indicator, codeTypes = "LAD") %>%  -->
<!--   filter(subgroup!="Y" & ageCat !="unknown" & ageCat != "<6") %>% mutate(ageCat=as.character(ageCat)) %>% -->
<!--   tsp$aggregateGender() %>% tsp$aggregateSubgroup() %>% inner_join(dmg %>% mutate(ageCat=as.character(ageCat)), by=c("code","ageCat"), suffix=c("","rhs")) %>% rename(population=count) -->

<!-- tmp2 = tmp %>% bind_rows( -->
<!--   tmp %>% tsp$aggregateAge() %>% mutate(ageCat="All") -->
<!-- ) %>% mutate(ageCat = factor(ageCat,levels=c("6-10","11-18","19-22","23-59","60-75","75+","All"),ordered=TRUE)) -->

<!-- uniVsRestCasesGeog = tmp2 %>% tsp$logIncidenceStats() -->
<!-- maxDate = (tmp2 %>% pull(date) %>% max())-4 -->

<!-- map = dpc$geog$getMap("LAD19") %>% inner_join(uniVsRestCasesGeog %>% filter(date == maxDate) %>% select(-name,-codeType), by=c("code")) -->
<!-- ``` -->


<!-- ## University age va gen pop growth rates by region r maxDate -->

<!-- ```{r} -->
<!-- p3 = ggplot(map %>% ungroup() %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.windowed.value),size = 0.05) + facet_wrap(vars(ageCat), ncol = 5) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_gradient2( -->
<!--   midpoint=0, low="#008837", mid="#f7f7f7", high="#7b3294", name="growth rate", oob=scales::squish, lim=c(-0.10,0.10)) -->
<!-- p3 %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/UniversityGrowth") -->
<!-- ``` -->


<!-- ## University age vs gen pop $P(r>0)$ on r maxDate -->

<!-- ```{r} -->
<!-- p3 = ggplot(map %>% ungroup() %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.windowed.ProbPos.value),size = 0.05) + facet_wrap(vars(ageCat), ncol = 5) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_viridis_c(name="P(growth rate>0)") #trans="log1p") -->
<!-- p3 %>% standardPrintOutput::saveFigure(maxWidth = 12,maxHeight = 6,filename = "~/Dropbox/covid19/by-age/UniversityGrowthProbPos") -->
<!-- ``` -->

```{r}

ageBreaks = c(6,11,18,23,60,75);

cases = dpc$spim$getLineListIncidence(ageBreaks = ageBreaks,subgroup = asymptomatic_indicator) %>% filter(ageCat !="unknown")
deaths = dpc$spim$getDeathsLineListIncidence(ageBreaks = ageBreaks)

```

## Cases and deaths incidence by functional age category 

```{r}
totalCases = cases %>% filter(subgroup!="Y") %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender()
totalDeaths = deaths %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% filter(ageCat %in% c("23-59","60-74","75+"))
combined = bind_rows(totalCases,totalDeaths)  %>% tsp$logIncidenceStats(growthRateWindow = 7, leftSided=TRUE) %>% tsp$adjustGrowthRateDates() %>% dpc$demog$findDemographics()

p1 = (combined %>% filter(codeType=="CTRY") %>% tsp$plotIncidenceQuantiles(dates = startDate, events = events, colour=statistic, denominatorExpr = population/1000000)) + facet_wrap(vars(ageCat),ncol=4) + scale_y_continuous(trans="log1p", breaks = c(0,2,5,20,50,200,500,2000))+ylab("rate per 1M per day")

p1 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/CaseAndDeathCountsByAge")
```

## Cases and deaths growth by functional age category

```{r}
p2 = combined %>% filter(codeType=="CTRY") %>% tsp$plotGrowthRate(dates = startDate, events = events, colour=statistic, rlim = c(-0.1,0.2), leftSided=TRUE) + facet_wrap(vars(ageCat),ncol=4)
# tsp$estimateRt(window = 14) %>%  tsp$plotRt(dates = "2020-08-01", events = events2) + facet_wrap(vars(ageCat))
p2 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/CaseAndDeathGrowthByAge")
```

## London versus North West case growth by functional age category

```{r}
#p2 = 
tmp = combined %>% filter(codeType=="NHSER" & statistic=="case" & name!="unknown")

p2 = tmp %>% tsp$plotGrowthRate(dates = startDate, events = events, group=name, rlim = c(-0.1,0.2), colour="grey50") +
  plotRibbons(data = tmp %>% filter(name=="North West"),meanVar = `Growth.value`,sdVar = `Growth.SE.value`,colourExpr = "red") +
  plotRibbons(data = tmp %>% filter(name=="London"),meanVar = `Growth.value`,sdVar = `Growth.SE.value`,colourExpr = "blue") +
  facet_wrap(vars(ageCat),ncol=4)#+
  #gghighlight::gghighlight(name %in% c("London","North West"))
  #scale_color_manual(
  #  values = highlightList(vector=tmp3$name,list("North West"="dark red","London"="dark blue")))
# tsp$estimateRt(window = 14) %>%  tsp$plotRt(dates = "2020-08-01", events = events2) + facet_wrap(vars(ageCat))
p2 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/RegionalDivideGrowthByAge")
```

## Case growth versus incidence by age and region

```{r}

#tmp3 = totalCases %>% tsp$logIncidenceStats(growthRateWindow = 14) %>% filter(codeType=="NHSER" & statistic=="case" & name!="unknown") %>% tsp$demog$findDemographics()

maxDate = (totalCases %>% pull(date) %>% max())
#plotDates = seq(maxDate,by = -14,length.out = 4)

p2 = (totalCases %>% filter(code != "E99999999") %>% group_by(name,ageCat) %>% tsp$plotGrowthIncidence(plotDates = maxDate,timespan = 31, populationExpr = population, colour = ageCat,maxSize = 4))+scale_color_manual(values = highlightList(vector=totalCases$ageCat,list("75+"="dark magenta","11-17"="#008000","6-10"="#00B000")))+facet_wrap(vars(name),ncol=4)+
  xlab("7 day growth rate")+ylab("Symptomatic positives per 1M per day")

p2 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/GrowthVsIncidenceByAgeAndRegion")
#+facet_grid(cols=vars(plotDate),rows = vars(name))
```



```{r}

dmg = dpc$demog$getDemographicsForShape(mapId = "LAD19",ageBreaks = ageBreaks, combineGenders = TRUE)

tmp = dpc$spim$getLineListIncidence(ageBreaks = ageBreaks, codeTypes = "LAD",subgroup=asymptomatic_indicator) %>% 
  filter(ageCat !="unknown" & subgroup!="Y") %>% mutate(ageCat=as.character(ageCat)) %>%
  tsp$aggregateGender() %>% tsp$aggregateSubgroup() %>% inner_join(dmg %>% mutate(ageCat=as.character(ageCat)), by=c("code","ageCat"), suffix=c("","rhs")) %>% rename(population=count)

other = tmp %>% filter(ageCat %in% c("<6","23-59")) %>% tsp$aggregateAge() %>% mutate(ageCat="other family")
school = tmp %>% filter(ageCat %in% c("6-10","11-17")) %>% tsp$aggregateAge() %>% mutate(ageCat="school")
university = tmp %>% filter(ageCat %in% c("18-22")) %>% tsp$aggregateAge() %>% mutate(ageCat="university")
youngOlder = tmp %>% filter(ageCat %in% c("60-74")) 
oldOlder = tmp %>% filter(ageCat %in% c("75+")) 
all = tmp %>% tsp$aggregateAge() %>% mutate(ageCat="all")

tmp2 = bind_rows(
  other,school,university,youngOlder, oldOlder,all
) %>% mutate(ageCat = factor(ageCat,levels=c("school","university","other family","60-74","75+","all"),ordered=TRUE))
```

```{r}
casesGeog = tmp2 %>% tsp$estimateGrowthRate2()
maxDate = (tmp2 %>% pull(date) %>% max())

map = dpc$geog$getMap("LAD19") %>% inner_join(casesGeog %>% filter(date == maxDate) %>% select(-name,-codeType), by=c("code"))
```

## LTLA distribution of case growth and probability of positive growth

```{r}
p3a = ggplot(map %>% ungroup() %>% filter(ageCat=="all") %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.value),size = 0.05) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_distiller(palette = "RdGy", name="growth rate", oob=scales::squish, lim=c(-0.10,0.10))

p5a = ggplot(map %>% ungroup() %>% filter(ageCat=="all") %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.ProbPos),size = 0.05) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_distiller(palette = "RdYlGn", name="P(r>0)",lim = c(0,1))
(p3a + p5a + patchwork::plot_layout(nrow=1)) %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/CaseGrowthAndPGrowthPosByLAD")
```


## LTLA distribution of case growth by functional age category

```{r}
p4 = ggplot(map %>% ungroup() %>% filter(ageCat!="all") %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.value),size = 0.05) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_distiller(palette = "RdGy", name="growth rate", oob=scales::squish, lim=c(-0.10,0.10)) + facet_wrap(vars(ageCat), nrow = 1)
p4 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/CaseGrowthByAgeAndLAD")
```

## LTLA distribution of probability of positive growth by functional age category

```{r}
p5 = ggplot(map %>% ungroup() %>% filter(ageCat!="all") %>% sf::st_as_sf()) + geom_sf(aes(fill=Growth.ProbPos),size = 0.05) + facet_wrap(vars(ageCat), nrow=1) + standardPrintOutput::defaultMapLayout() + standardPrintOutput::narrower() + scale_fill_distiller(palette = "RdYlGn", name="P(r>0)",lim = c(0,1)) #, oob=scales::squish, lim=c(-0.10,0.10))
p5 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/CasePGrowthPosByAgeAndLAD")
```

## Relative proportion of cases by age

```{r}
totalCases2 = totalCases %>% tsp$estimateGrowthRate2()
totalCases2 = totalCases2 %>% group_by(date,codeType,code,name) %>% mutate(totalAllAges = sum(Est.value), percentAllAges = Est.value/sum(Est.value))

p1=ggplot(totalCases2 %>% filter(name=="England" & date > startDate),aes(x=date,y=percentAllAges*100,fill=ageCat)) + geom_area()+ylab("%age of total") + scale_x_date(date_breaks = "2 weeks",date_labels = "%d-%m")#+
  #tsp$plotEvents(events %>% filter(`Start date`> startDate),labelSize = 10,labelY=75)

p1 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/RelativeCasesByAgeGroup")
```

## Relative proportion of cases by age and region

```{r}
p1 = ggplot(totalCases2 %>% filter(codeType=="NHSER" & date > startDate),aes(x=date,y=percentAllAges*100,fill=ageCat)) + geom_area()+facet_wrap(vars(name),ncol=4)+ylab("%age of total") + scale_x_date(date_breaks = "4 weeks",date_labels = "%d-%m")#+
  #tsp$plotEvents(events %>% filter(`Start date`> startDate),labelSize = 8,labelY=75)

p1 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/RelativeCasesByAgeGroupAndRegion")
```

## Relative proportion of deaths by age



```{r}
ageBreaks = c(25,40,50,60,70,80);
deaths2 = dpc$spim$getDeathsLineListIncidence(ageBreaks = ageBreaks, filterExpr = !is.na(NHSE))
totalDeaths2 = deaths2 %>% tsp$aggregateSubgroup() %>% tsp$aggregateGender() %>% tsp$logIncidenceStats()
totalDeaths2 = totalDeaths2 %>% group_by(date,codeType,code,name) %>% mutate(totalAllAges = sum(Est.value), percentAllAges = Est.value/sum(Est.value))

p2 = ggplot(totalDeaths2 %>% filter(name=="England" & date > startDate),aes(x=date,y=percentAllAges*100,fill=ageCat)) + geom_area()+ylab("%age of total") + scale_x_date(date_breaks = "2 weeks",date_labels = "%d-%m")+scale_fill_brewer(palette = "Pastel1")#+
  #tsp$plotEvents(events %>% filter(`Start date`> startDate),labelSize = 10,labelY=75)

p2 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/RelativeDeathsByAgeGroup")
```

## Relative proportion of hospital deaths by age and region

```{r}
p2 = ggplot(totalDeaths2 %>% filter(codeType=="NHSER" & date > startDate),aes(x=date,y=percentAllAges*100,fill=ageCat)) + geom_area()+facet_wrap(vars(name),ncol=4)+ylab("%age of total") + scale_x_date(date_breaks = "4 weeks",date_labels = "%d-%m")+
  #tsp$plotEvents(events %>% filter(`Start date`> startDate),labelSize = 6,labelY=75)+
  scale_fill_brewer(palette = "Pastel1")

p2 %>% standardPrintOutput::saveThirdPageFigure("~/Dropbox/covid19/by-age/RelativeDeathsByAgeGroupAndRegion")
```
